<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Full-Stack App (Student Build)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <nav class="navbar" style="background-color:#126cac;">
    <div class="container">
      <!-- Left side brand -->
      <a class="navbar-brand fw-bold text-white" href="#" id="navBrand">Full-Stack App</a>

      <!-- Right side links -->
      <div class="d-flex  align-items-center gap-3 ms-auto">
        <div id="authLinks" class="d-flex align-items-center gap-2">
          <a href="#" id="navLogin" class="nav-link text-white fw-semibold">Login</a>
          <a href="#" id="navRegister" class="nav-link text-white fw-semibold">Register</a>
        </div>

        <div id="userDropdown" class="dropdown d-none">
          <button class="btn btn-info dropdown-toggle" id="userDropdownToggle" type="button" aria-expanded="false">
            User
          </button>
          <ul class="dropdown-menu dropdown-menu-end" id="userDropdownMenu">
            <li><a class="dropdown-item" href="#" id="ddProfile">Profile</a></li>
            <li><a class="dropdown-item" href="#" id="ddEmployees">Employees</a></li>
            <li><a class="dropdown-item" href="#" id="ddAccounts">Accounts</a></li>
            <li><a class="dropdown-item" href="#" id="ddDepartments">Departments</a></li>
            <li><a class="dropdown-item" href="#" id="ddRequests">My Requests</a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item text-danger" href="#" id="ddLogout">Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>


  <main class="container py-5">
    <section id="homeSection">
      <h1 class="display-5 fw-bold">Welcome to Full-Stack App</h1>
      <p class="text-muted">
        A static prototype before backend integration. Simulates:
      </p>


      <ul>
        <li>Email registration + fake verification</li>
        <li>Login with JWT-like token simulation</li>
        <li>Role-based UI (Admin/User)</li>
        <li>CRUD for Employees, Departments, Requests</li>
      </ul>


      <div class="alert alert-warning d-flex align-items-center mt-4" role="alert">
        <span class="me-2">!</span>
        <div>
          <strong>Note:</strong> This demo uses a simple in-memory backend and a session token.
        </div>
      </div>


      <a class="btn btn-primary btn-lg" href="#get-started">
        Get Started →
      </a>
    </section>


    <section id="registerSection" class="d-none">

      <h2 class="mt-4" id="register">Register Account</h2>
      <form id="registerForm" class="mt-4" style="max-width: 420px;">
        <div class="mb-3">
          <label class="form-label">First Name</label>
          <input type="text" class="form-control" id="regFirstName" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Last Name</label>
          <input type="text" class="form-control" id="regLastName" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="regEmail" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="regPassword" required>
        </div>
        <div class="d-grid gap-3 d-md-block">
          <button type="submit" class="btn btn-primary mt-2 me-2">Register</button>
          <button type="button" id="cancelRegister" class="btn btn-outline-secondary mt-2">Cancel</button>
        </div>

      </form>

      <div id="registerAlert" class="mt-3"></div>
    </section>

    <section id="loginSection" class="d-none">
      <h2 class="mt-4" id="login"> Login</h2>
      <form id="loginForm" style="max-width: 400px;" class="mt-4 ">
        <div class="mb-3">
          <label class="form-label">Username</label>
          <input type="text" class="form-control" id="loginEmail" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="loginPassword" required>
        </div>
        <div class="d-grid gap-3 d-md-block">
          <button type="submit" class="btn btn-primary mt-2 me-2">Login</button>
          <button type="button" id="cancelLogin" class="btn btn-outline-secondary mt-2">Cancel</button>
        </div>
      </form>
      <div id="loginAlert" class="mt-3"></div>
    </section>

    <section id="profileSection" class="d-none">
      <h2 class="mt-4">My Profile</h2>
      <div class="card p-4" style="max-width: 400px;">
        <div id="profileName" class="fw-bold mb-1">Admin user</div>
        <div><strong>Email:</strong> <span id="profileEmail">admin@example</span></div>
        <div><strong>Role:</strong> <span id="profileRole">Admin</span></div>
        <button class="btn btn-outline-primary mt-3" id="editProfileBtn">Edit Profile</button>
      </div>

      <div id="editProfileCard" class="card p-4 mt-3 d-none" style="max-width: 400px;">
        <h5 class="mb-3">Edit Profile</h5>
        <div class="mb-3">
          <label class="form-label">First Name <small class="text-muted">(min 2 chars)</small></label>
          <input type="text" class="form-control" id="editFirstName">
        </div>
        <div class="mb-3">
          <label class="form-label">Last Name <small class="text-muted">(min 2 chars)</small></label>
          <input type="text" class="form-control" id="editLastName">
        </div>
        <div class="mb-3">
          <label class="form-label">New Password <small class="text-muted">(min 6 chars, leave blank to keep)</small></label>
          <input type="password" class="form-control" id="editPassword">
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" id="saveProfileBtn">Save</button>
          <button class="btn btn-outline-secondary" id="cancelEditProfileBtn">Cancel</button>
        </div>
        <div id="editProfileAlert" class="mt-3"></div>
      </div>
    </section>
    <section id="employeesSection" class="d-none">
      <div class="d-flex align-items-center justify-content-between mt-4">
        <h2 class="mb-0">Employees</h2>
        <button class="btn btn-success" id="btnAddEmployee">+ Add Employee</button>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Position</th>
              <th>Dept</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="employeesTableBody">
            <tr>
              <td colspan="5" class="text-center text-muted">No employees.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card p-3 mt-4" style="max-width: 560px;">
        <h5 class="mb-3" id="empFormTitle">Add Employee</h5>
        <input type="hidden" id="empEditId">
        <div class="mb-3">
          <label class="form-label">Employee ID</label>
          <input type="text" class="form-control" id="empEmployeeId" placeholder="e.g. EMP-001">
        </div>
        <div class="mb-3">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" id="empName" placeholder="e.g. Juan dela Cruz">
        </div>
        <div class="mb-3">
          <label class="form-label">User Email</label>
          <input type="email" class="form-control" id="empUserEmail" placeholder="name@example.com">
        </div>
        <div class="mb-3">
          <label class="form-label">Position</label>
          <input type="text" class="form-control" id="empPosition" placeholder="e.g. QA Engineer">
        </div>
        <div class="mb-3">
          <label class="form-label">Department</label>
          <select class="form-select" id="empDepartment">
            <option value="">-- Select Department --</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Hire Date</label>
          <input type="date" class="form-control" id="empHireDate">
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" id="empSaveBtn">Save</button>
          <button class="btn btn-outline-secondary" id="empCancelBtn">Cancel</button>
        </div>
      </div>
    </section>

    <section id="accountsSection" class="d-none">
      <div class="d-flex align-items-center justify-content-between mt-4">
        <h2 class="mb-0">Accounts</h2>
        <button class="btn btn-success" id="btnAddAccount">+ Add Account</button>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Verified</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="accountsTableBody">
          </tbody>
        </table>
      </div>

      <div class="card p-3 mt-4" style="max-width: 560px;">
        <h5 class="mb-3" id="accFormTitle">Add Account</h5>
        <input type="hidden" id="accEditId">
        <div class="mb-3">
          <label class="form-label">First Name</label>
          <input type="text" class="form-control" id="accFirstName">
        </div>
        <div class="mb-3">
          <label class="form-label">Last Name</label>
          <input type="text" class="form-control" id="accLastName">
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="accEmail">
        </div>
        <div class="mb-3">
          <label class="form-label">Password <small class="text-muted">(leave blank to keep)</small></label>
          <input type="password" class="form-control" id="accPassword">
        </div>
        <div class="mb-3">
          <label class="form-label">Role</label>
          <select class="form-select" id="accRole">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="accVerified">
          <label class="form-check-label" for="accVerified">
            Verified
          </label>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" id="accSaveBtn">Save</button>
          <button class="btn btn-outline-secondary" id="accCancelBtn">Cancel</button>
        </div>
      </div>
    </section>
   <section id="departmentsSection" class="d-none">
  <div class="d-flex align-items-center justify-content-between mt-4">
    <h2 class="mb-0">Departments</h2>
    <button class="btn btn-success" id="btnAddDepartment">+ Add Department</button>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="departmentsTableBody">
      </tbody>
    </table>
  </div>

  <div class="card p-3 mt-4" style="max-width: 560px;">
    <h5 class="mb-3" id="deptFormTitle">Add Department</h5>
    <input type="hidden" id="deptEditId">
    <div class="mb-3">
      <label class="form-label">Name</label>
      <input type="text" class="form-control" id="deptName" placeholder="e.g. Engineering">
    </div>
    <div class="mb-3">
      <label class="form-label">Description</label>
      <input type="text" class="form-control" id="deptDescription" placeholder="e.g. Software team">
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" id="deptSaveBtn">Save</button>
      <button class="btn btn-outline-secondary" id="deptCancelBtn">Cancel</button>
    </div>
  </div>
</section>
<section id="requestsSection" class="d-none">
  <div class="d-flex align-items-center justify-content-between mt-4">
    <h2 class="mb-0" id="requestsTitle">My Requests</h2>
    <button class="btn btn-success" id="btnNewRequest">+ New Request</button>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th id="reqColRequester" class="d-none">Requester</th>
          <th>Type</th>
          <th>Items</th>
          <th>Status</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="requestsTableBody">
      </tbody>
    </table>
  </div>

  <div id="newRequestCard" class="card p-3 mt-4 d-none" style="max-width: 560px;">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0">New Request</h5>
      <button class="btn-close" aria-label="Close" id="btnCloseRequest"></button>
    </div>

    <div class="mb-3">
      <label class="form-label">Type</label>
      <select class="form-select" id="reqType">
        <option value="Equipment">Equipment</option>
        <option value="Leave">Leave</option>
        <option value="Supplies">Supplies</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Items</label>
      <div id="reqItemsList"></div>
      <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="btnAddItem">+ Add Item</button>
    </div>

    <button class="btn btn-primary mt-2" id="btnSubmitRequest">Submit Request</button>
  </div>
</section>

  </main>
  <script>
    const homeSection = document.getElementById("homeSection");
    const registerSection = document.getElementById("registerSection");
    const loginSection = document.getElementById("loginSection");

    const registerForm = document.getElementById("registerForm");
    const firstNameInput = document.getElementById("regFirstName");
    const lastNameInput = document.getElementById("regLastName");
    const emailInput = document.getElementById("regEmail");
    const passwordInput = document.getElementById("regPassword");
    const alertDiv = document.getElementById("registerAlert");

    const loginForm = document.getElementById("loginForm");
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");
    const loginAlert = document.getElementById("loginAlert");

    const profileSection = document.getElementById("profileSection");
    const profileName = document.getElementById("profileName");
    const profileEmail = document.getElementById("profileEmail");
    const profileRole = document.getElementById("profileRole");
    const editProfileBtn = document.getElementById("editProfileBtn");
    const editProfileCard = document.getElementById("editProfileCard");
    const editFirstNameInput = document.getElementById("editFirstName");
    const editLastNameInput = document.getElementById("editLastName");
    const editPasswordInput = document.getElementById("editPassword");
    const editProfileAlert = document.getElementById("editProfileAlert");
    const saveProfileBtn = document.getElementById("saveProfileBtn");
    const cancelEditProfileBtn = document.getElementById("cancelEditProfileBtn");
    const navBrand = document.getElementById("navBrand");
    const authLinks = document.getElementById("authLinks");
    const userDropdown = document.getElementById("userDropdown");
    const userDropdownToggle = document.getElementById("userDropdownToggle");
    const userDropdownMenu = document.getElementById("userDropdownMenu");
    const ddProfile = document.getElementById("ddProfile");
    const ddEmployees = document.getElementById("ddEmployees");
    const ddAccounts = document.getElementById("ddAccounts");
    const ddDepartments = document.getElementById("ddDepartments");
    const ddRequests = document.getElementById("ddRequests");
    const ddLogout = document.getElementById("ddLogout");

    const employeesSection = document.getElementById("employeesSection");
    const employeesTableBody = document.getElementById("employeesTableBody");

    const empEmployeeIdInput = document.getElementById("empEmployeeId");
    const empUserEmailInput = document.getElementById("empUserEmail");
    const empPositionInput = document.getElementById("empPosition");
    const empDepartmentInput = document.getElementById("empDepartment");
    const empHireDateInput = document.getElementById("empHireDate");
    const empSaveBtn = document.getElementById("empSaveBtn");
    const empCancelBtn = document.getElementById("empCancelBtn");
    const empNameInput = document.getElementById("empName");
    const empEditIdInput = document.getElementById("empEditId");
    const empFormTitle = document.getElementById("empFormTitle");
    const btnAddEmployee = document.getElementById("btnAddEmployee");

    const accountsSection = document.getElementById("accountsSection");
    const accountsTableBody = document.getElementById("accountsTableBody");
    const btnAddAccount = document.getElementById("btnAddAccount");
    const accFirstNameInput = document.getElementById("accFirstName");
    const accLastNameInput = document.getElementById("accLastName");
    const accEmailInput = document.getElementById("accEmail");
    const accPasswordInput = document.getElementById("accPassword");
    const accRoleInput = document.getElementById("accRole");
    const accVerifiedInput = document.getElementById("accVerified");
    const accEditIdInput = document.getElementById("accEditId");
    const accFormTitle = document.getElementById("accFormTitle");
    const accSaveBtn = document.getElementById("accSaveBtn");
    const accCancelBtn = document.getElementById("accCancelBtn");
    const departmentsSection = document.getElementById("departmentsSection");
    const departmentsTableBody = document.getElementById("departmentsTableBody");
    const btnAddDepartment = document.getElementById("btnAddDepartment");
    const deptNameInput = document.getElementById("deptName");
    const deptDescriptionInput = document.getElementById("deptDescription");
    const deptEditIdInput = document.getElementById("deptEditId");
    const deptFormTitle = document.getElementById("deptFormTitle");
    const deptSaveBtn = document.getElementById("deptSaveBtn");
    const deptCancelBtn = document.getElementById("deptCancelBtn");
    const requestsSection = document.getElementById("requestsSection");
    const requestsTableBody = document.getElementById("requestsTableBody");
    const requestsTitle = document.getElementById("requestsTitle");
    const reqColRequester = document.getElementById("reqColRequester");
    const btnNewRequest = document.getElementById("btnNewRequest");
    const btnCloseRequest = document.getElementById("btnCloseRequest");
    const newRequestCard = document.getElementById("newRequestCard");
    const reqTypeInput = document.getElementById("reqType");
    const reqItemsList = document.getElementById("reqItemsList");
    const btnAddItem = document.getElementById("btnAddItem");
    const btnSubmitRequest = document.getElementById("btnSubmitRequest");

    const AUTH_TOKEN_KEY = "authToken";
    let loggedInUser = null;

    async function login(username, password) {
      try {
        const response = await fetch('http://localhost:5500/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok) {
          sessionStorage.setItem('authToken', data.token);
          showDashboard(data.user);
          return true;
        } else {
          loginAlert.innerHTML = `<div class="alert alert-danger"><strong>Error!</strong> ${data.error || 'Invalid credentials.'}</div>`;
          return false;
        }
      } catch (err) {
        loginAlert.innerHTML = '<div class="alert alert-danger">Network error. Please try again.</div>';
        return false;
      }
    }

    function showDashboard(user) {
      applyAuthState(user);
      showSection(profileSection);
      loadProfile();
    }

    function getAuthHeader() {
      const token = sessionStorage.getItem('authToken');
      return token ? { Authorization: `Bearer ${token}` } : {};
    }

    async function loadAdminDashboard() {
      const res = await fetch('http://localhost:5500/api/admin/dashboard', {
        headers: getAuthHeader()
      });
      if (res.ok) {
        const data = await res.json();
        document.getElementById('content').innerText = data.message;
      } else {
        document.getElementById('content').innerText = 'Access denied!';
      }
    }

    async function loadEmployees() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) {
        alert("You must be logged in as admin to see employees.");
        return;
      }

      try {
        const response = await fetch('/api/employees', {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (!response.ok) {
          alert(data.error || "Failed to load employees.");
          return;
        }

        const list = data.employees || [];

        // limpyo sa sulod sa table body
        employeesTableBody.innerHTML = "";

        if (list.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td colspan="5" class="text-center text-muted">No employees.</td>
          `;
          employeesTableBody.appendChild(row);
          return;
        }

        // himo og row para sa matag employee
        list.forEach(emp => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${emp.id}</td>
            <td>${emp.name}</td>
            <td>${emp.position}</td>
            <td>${emp.department}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editEmployee(${emp.id})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee(${emp.id})">Delete</button>
            </td>
          `;
          employeesTableBody.appendChild(row);
        });
      } catch (err) {
        alert("Network error while loading employees.");
      }
    }

    function resetEmployeeForm() {
      empEditIdInput.value = "";
      empEmployeeIdInput.value = "";
      empNameInput.value = "";
      empUserEmailInput.value = "";
      empPositionInput.value = "";
      empDepartmentInput.value = "";
      empHireDateInput.value = "";
      empFormTitle.textContent = "Add Employee";
    }

    async function saveEmployee() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) {
        alert("You must be logged in as admin.");
        return;
      }

      const editId = empEditIdInput.value;
      const employeeCode = empEmployeeIdInput.value.trim();
      const name = empNameInput.value.trim();
      const email = empUserEmailInput.value.trim();
      const position = empPositionInput.value.trim();
      const department = empDepartmentInput.value.trim();
      const hireDate = empHireDateInput.value;

      if (!employeeCode || !name || !email || !position || !department) {
        alert("Please fill in all required fields.");
        return;
      }

      const url = editId ? `/api/employees/${editId}` : '/api/employees';
      const method = editId ? 'PUT' : 'POST';

      try {
        const response = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ employeeCode, name, email, position, department, hireDate })
        });

        const data = await response.json();

        if (!response.ok) {
          alert(data.error || "Failed to save employee.");
          return;
        }

        alert(editId ? "Employee updated!" : "Employee added!");
        resetEmployeeForm();
        await loadEmployees();
      } catch (err) {
        alert("Network error while saving employee.");
      }
    }

    async function editEmployee(id) {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      try {
        const response = await fetch(`/api/employees/${id}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to fetch employee.");
          return;
        }
        const emp = data.employee;
        empEditIdInput.value = emp.id;
        empEmployeeIdInput.value = emp.employeeCode || '';
        empNameInput.value = emp.name || '';
        empUserEmailInput.value = emp.email || '';
        empPositionInput.value = emp.position || '';
        empDepartmentInput.value = emp.department || '';
        empHireDateInput.value = emp.hireDate || '';
        empFormTitle.textContent = "Edit Employee";
      } catch (err) {
        alert("Network error while loading employee.");
      }
    }

    async function deleteEmployee(id) {
      if (!confirm("Delete this employee?")) return;
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      try {
        const response = await fetch(`/api/employees/${id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to delete employee.");
          return;
        }
        await loadEmployees();
      } catch (err) {
        alert("Network error while deleting employee.");
      }
    }

    async function loadAccounts() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) {
        alert("You must be logged in as admin to see accounts.");
        return;
      }

      try {
        const response = await fetch('/api/accounts', {
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = await response.json();

        if (!response.ok) {
          alert(data.error || "Failed to load accounts.");
          return;
        }

        const list = data.accounts || [];
        accountsTableBody.innerHTML = "";

        if (list.length === 0) {
          accountsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No accounts.</td></tr>`;
          return;
        }

        list.forEach(acc => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${acc.firstName || ''} ${acc.lastName || ''}</td>
            <td>${acc.username}</td>
            <td>${acc.role}</td>
            <td class="${acc.verified ? 'text-success fw-bold' : 'text-muted'}">${acc.verified ? '✔' : '✘'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editAccount(${acc.id})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount(${acc.id})">Delete</button>
            </td>
          `;
          accountsTableBody.appendChild(row);
        });
      } catch (err) {
        alert("Network error while loading accounts.");
      }
    }

    function resetAccountForm() {
      accEditIdInput.value = "";
      accFirstNameInput.value = "";
      accLastNameInput.value = "";
      accEmailInput.value = "";
      accPasswordInput.value = "";
      accRoleInput.value = "user";
      accVerifiedInput.checked = false;
      accFormTitle.textContent = "Add Account";
    }

    async function saveAccount() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) {
        alert("You must be logged in as admin.");
        return;
      }

      const editId = accEditIdInput.value;
      const firstName = accFirstNameInput.value.trim();
      const lastName = accLastNameInput.value.trim();
      const email = accEmailInput.value.trim();
      const password = accPasswordInput.value.trim();
      const role = accRoleInput.value || "user";
      const verified = accVerifiedInput.checked;

      if (firstName.length < 2) {
        alert("First name must be at least 2 characters.");
        return;
      }
      if (lastName.length < 2) {
        alert("Last name must be at least 2 characters.");
        return;
      }
      if (!email) {
        alert("Email is required.");
        return;
      }
      if (!editId && !password) {
        alert("Password is required for new accounts.");
        return;
      }
      if (password && password.length < 6) {
        alert("Password must be at least 6 characters.");
        return;
      }

      const body = { username: email, firstName, lastName, role, verified };
      if (password) body.password = password;

      const url = editId ? `/api/accounts/${editId}` : '/api/accounts';
      const method = editId ? 'PUT' : 'POST';

      try {
        const response = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (!response.ok) {
          alert(data.error || "Failed to save account.");
          return;
        }

        alert(editId ? "Account updated!" : "Account created!");
        resetAccountForm();
        await loadAccounts();
      } catch (err) {
        alert("Network error while saving account.");
      }
    }

    async function deleteAccount(id) {
      if (!confirm("Delete this account?")) return;

      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      try {
        const response = await fetch(`/api/accounts/${id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to delete account.");
          return;
        }

        await loadAccounts();
      } catch (err) {
        alert("Network error while deleting account.");
      }
    }

    async function editAccount(id) {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      try {
        const response = await fetch(`/api/accounts/${id}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to fetch account.");
          return;
        }

        const acc = data.account;
        accEditIdInput.value = acc.id;
        accFirstNameInput.value = acc.firstName || '';
        accLastNameInput.value = acc.lastName || '';
        accEmailInput.value = acc.username;
        accPasswordInput.value = '';
        accRoleInput.value = acc.role;
        accVerifiedInput.checked = acc.verified || false;
        accFormTitle.textContent = "Edit Account";
      } catch (err) {
        alert("Network error while loading account.");
      }
    }

    async function populateDeptDropdown() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) return;
      try {
        const response = await fetch('/api/departments', {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) return;
        const list = data.departments || [];
        empDepartmentInput.innerHTML = '<option value="">-- Select Department --</option>';
        list.forEach(dept => {
          const opt = document.createElement('option');
          opt.value = dept.name;
          opt.textContent = dept.name;
          empDepartmentInput.appendChild(opt);
        });
      } catch (err) { /* silent */ }
    }

    async function loadDepartments() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) {
        alert("You must be logged in as admin to see departments.");
        return;
      }
      try {
        const response = await fetch('/api/departments', {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to load departments.");
          return;
        }
        const list = data.departments || [];
        departmentsTableBody.innerHTML = "";
        if (list.length === 0) {
          departmentsTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No departments.</td></tr>`;
          return;
        }
        list.forEach(dept => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${dept.name}</td>
            <td>${dept.description || ''}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editDepartment(${dept.id})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartment(${dept.id})">Delete</button>
            </td>
          `;
          departmentsTableBody.appendChild(row);
        });
      } catch (err) {
        alert("Network error while loading departments.");
      }
    }

    function resetDeptForm() {
      deptEditIdInput.value = "";
      deptNameInput.value = "";
      deptDescriptionInput.value = "";
      deptFormTitle.textContent = "Add Department";
    }

    async function saveDepartment() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) {
        alert("You must be logged in as admin.");
        return;
      }
      const editId = deptEditIdInput.value;
      const name = deptNameInput.value.trim();
      const description = deptDescriptionInput.value.trim();
      if (!name) {
        alert("Department name is required.");
        return;
      }
      const url = editId ? `/api/departments/${editId}` : '/api/departments';
      const method = editId ? 'PUT' : 'POST';
      try {
        const response = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ name, description })
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to save department.");
          return;
        }
        alert(editId ? "Department updated!" : "Department added!");
        resetDeptForm();
        await loadDepartments();
      } catch (err) {
        alert("Network error while saving department.");
      }
    }

    async function deleteDepartment(id) {
      if (!confirm("Delete this department?")) return;
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      try {
        const response = await fetch(`/api/departments/${id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to delete department.");
          return;
        }
        await loadDepartments();
      } catch (err) {
        alert("Network error while deleting department.");
      }
    }

    async function editDepartment(id) {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      try {
        const response = await fetch(`/api/departments/${id}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to fetch department.");
          return;
        }
        const dept = data.department;
        deptEditIdInput.value = dept.id;
        deptNameInput.value = dept.name;
        deptDescriptionInput.value = dept.description || '';
        deptFormTitle.textContent = "Edit Department";
      } catch (err) {
        alert("Network error while loading department.");
      }
    }

    function addRequestItem() {
      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <input type="text" class="form-control req-item-name" placeholder="Item name">
        <input type="number" class="form-control req-item-qty" value="1" style="max-width:90px;">
        <button type="button" class="btn btn-outline-danger" onclick="this.closest('.input-group').remove()">×</button>
      `;
      reqItemsList.appendChild(div);
    }

    function resetRequestForm() {
      reqTypeInput.value = "Equipment";
      reqItemsList.innerHTML = "";
      addRequestItem();
    }

    async function loadRequests() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) return;
      const isAdmin = loggedInUser && loggedInUser.role === 'admin';
      requestsTitle.textContent = isAdmin ? "All Requests" : "My Requests";
      reqColRequester.classList.toggle("d-none", !isAdmin);
      try {
        const response = await fetch('/api/requests', {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to load requests.");
          return;
        }
        const list = data.requests || [];
        requestsTableBody.innerHTML = "";
        if (list.length === 0) {
          const cols = isAdmin ? 7 : 6;
          requestsTableBody.innerHTML = `<tr><td colspan="${cols}" class="text-center text-muted">No requests yet.</td></tr>`;
          return;
        }
        list.forEach(req => {
          const badgeClass = { pending: 'bg-warning text-dark', approved: 'bg-success', rejected: 'bg-danger' }[req.status] || 'bg-secondary';
          const itemsText = (req.items || []).map(i => `${i.name} (x${i.qty})`).join(', ') || '—';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${req.id}</td>
            ${isAdmin ? `<td>${req.username}</td>` : ''}
            <td>${req.type}</td>
            <td><small>${itemsText}</small></td>
            <td><span class="badge ${badgeClass}">${req.status}</span></td>
            <td>${req.createdAt}</td>
            <td>
              ${isAdmin ? `
                <button class="btn btn-sm btn-outline-success" onclick="updateRequestStatus(${req.id},'approved')">Approve</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="updateRequestStatus(${req.id},'rejected')">Reject</button>
              ` : ''}
              <button class="btn btn-sm btn-outline-danger" onclick="deleteRequest(${req.id})">Delete</button>
            </td>
          `;
          requestsTableBody.appendChild(row);
        });
      } catch (err) {
        alert("Network error while loading requests.");
      }
    }

    async function submitRequest() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) return;
      const type = reqTypeInput.value;
      const items = [];
      reqItemsList.querySelectorAll('.input-group').forEach(row => {
        const name = row.querySelector('.req-item-name').value.trim();
        const qty = parseInt(row.querySelector('.req-item-qty').value) || 1;
        if (name) items.push({ name, qty });
      });
      try {
        const response = await fetch('/api/requests', {
          method: 'POST',
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify({ type, items })
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to submit request.");
          return;
        }
        alert("Request submitted!");
        newRequestCard.classList.add("d-none");
        resetRequestForm();
        await loadRequests();
      } catch (err) {
        alert("Network error while submitting request.");
      }
    }

    async function deleteRequest(id) {
      if (!confirm("Delete this request?")) return;
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      try {
        const response = await fetch(`/api/requests/${id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to delete request.");
          return;
        }
        await loadRequests();
      } catch (err) {
        alert("Network error while deleting request.");
      }
    }

    async function updateRequestStatus(id, status) {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      try {
        const response = await fetch(`/api/requests/${id}/status`, {
          method: 'PUT',
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify({ status })
        });
        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Failed to update request status.");
          return;
        }
        await loadRequests();
      } catch (err) {
        alert("Network error while updating request status.");
      }
    }

    async function saveProfile() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) return;

      const firstName = editFirstNameInput.value.trim();
      const lastName = editLastNameInput.value.trim();
      const password = editPasswordInput.value.trim();

      if (firstName.length < 2) {
        editProfileAlert.innerHTML = '<div class="alert alert-danger">First name must be at least 2 characters.</div>';
        return;
      }
      if (lastName.length < 2) {
        editProfileAlert.innerHTML = '<div class="alert alert-danger">Last name must be at least 2 characters.</div>';
        return;
      }
      if (password && password.length < 6) {
        editProfileAlert.innerHTML = '<div class="alert alert-danger">Password must be at least 6 characters.</div>';
        return;
      }

      const body = { firstName, lastName };
      if (password) body.password = password;

      try {
        const response = await fetch('/api/profile', {
          method: 'PUT',
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify(body)
        });
        const data = await response.json();
        if (!response.ok) {
          editProfileAlert.innerHTML = `<div class="alert alert-danger">${data.error || "Failed to update profile."}</div>`;
          return;
        }
        editProfileAlert.innerHTML = '<div class="alert alert-success">Profile updated!</div>';
        await loadProfile();
        setTimeout(() => {
          editProfileCard.classList.add("d-none");
          editProfileAlert.innerHTML = '';
        }, 1500);
      } catch (err) {
        editProfileAlert.innerHTML = '<div class="alert alert-danger">Network error.</div>';
      }
    }

    function setUserMenuVisibility(isVisible) {
      userDropdown.classList.toggle("d-none", !isVisible);
      authLinks.classList.toggle("d-none", isVisible);
    }

    function setAdminLinksVisible(isAdmin) {
      const adminLinks = [ddEmployees, ddAccounts, ddDepartments];
      adminLinks.forEach(link => link.classList.toggle("d-none", !isAdmin));
    }

    function applyAuthState(user) {
      loggedInUser = user;
      if (loggedInUser) {
        userDropdownToggle.textContent =
          loggedInUser.role === "admin" ? "Admin" : "User";
        setUserMenuVisibility(true);
        setAdminLinksVisible(loggedInUser.role === "admin");
      } else {
        userDropdownToggle.textContent = "User";
        setUserMenuVisibility(false);
        setAdminLinksVisible(false);
      }
    }

    async function tryRestoreSession() {
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) return;

      try {
        const response = await fetch('/api/profile', {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await response.json();

        if (response.ok && data.user) {
          applyAuthState({
            username: data.user.username,
            role: data.user.role
          });
        } else {
          sessionStorage.removeItem(AUTH_TOKEN_KEY);
        }
      } catch {
        sessionStorage.removeItem(AUTH_TOKEN_KEY);
      }
    }

    applyAuthState(null);


    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if (!firstName || !lastName || !email || !password) {
        alertDiv.innerHTML = '<div class="alert alert-danger">All fields are required.</div>';
        return;
      }
      if (firstName.length < 2) {
        alertDiv.innerHTML = '<div class="alert alert-danger">First name must be at least 2 characters.</div>';
        return;
      }
      if (lastName.length < 2) {
        alertDiv.innerHTML = '<div class="alert alert-danger">Last name must be at least 2 characters.</div>';
        return;
      }
      if (password.length < 6) {
        alertDiv.innerHTML = '<div class="alert alert-danger">Password must be at least 6 characters.</div>';
        return;
      }

      alertDiv.innerHTML = '<div class="alert alert-info">Registering...</div>';

      const response = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: email,
          password,
          role: 'user',
          firstName,
          lastName
        })
      });

      const data = await response.json();

      if (response.ok) {
        alertDiv.innerHTML = `<div class="alert alert-success"><strong>Success!</strong> ${data.message || 'Registered.'}</div>`;
        registerForm.reset();

        setTimeout(() => {
          showSection(loginSection);
          alertDiv.innerHTML = '';
        }, 2000);
      } else {
        alertDiv.innerHTML = `<div class="alert alert-danger"><strong>Error!</strong> ${data.error || data.message || 'Registration failed.'}</div>`;
      }
    });

    function showSection(section) {
      homeSection.classList.add("d-none");
      registerSection.classList.add("d-none");
      loginSection.classList.add("d-none");
      profileSection.classList.add("d-none");
      employeesSection.classList.add("d-none");
      accountsSection.classList.add("d-none");
      departmentsSection.classList.add("d-none");
      requestsSection.classList.add("d-none");




      section.classList.remove("d-none");
    }


    navBrand.onclick = (e) => {
      e.preventDefault();
      showSection(homeSection);
    };

    document.getElementById("navRegister").onclick = (e) => {
      e.preventDefault();
      showSection(registerSection);
    };


    document.getElementById("navLogin").onclick = (e) => {
      e.preventDefault();
      showSection(loginSection);
    };

    document.getElementById("cancelRegister").onclick = () => {
      showSection(homeSection);
    };

    document.getElementById("cancelLogin").onclick = () => {
      showSection(homeSection);
    };

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = loginEmailInput.value.trim();
      const password = loginPasswordInput.value.trim();

      if (!email || !password) return;

      loginAlert.innerHTML = '<div class="alert alert-info">Logging in...</div>';

      const success = await login(email, password);
      if (success) {
        loginAlert.innerHTML = '<div class="alert alert-success"><strong>Success!</strong> Login successful.</div>';
        loginForm.reset();
      }
    });

    async function loadProfile() {
      if (!loggedInUser) return;
      const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) return;
      const response = await fetch('/api/profile', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await response.json();

      if (response.ok && data.user) {
        const user = data.user;
        const fullName = [user.firstName, user.lastName].filter(Boolean).join(' ') || user.username || "User";
        profileName.textContent = fullName;
        profileEmail.textContent = user.username || "";
        profileRole.textContent = user.role || "User";
        editFirstNameInput.value = user.firstName || '';
        editLastNameInput.value = user.lastName || '';
        editPasswordInput.value = '';
      } else {
        profileName.textContent = "User not found";
        profileEmail.textContent = "";
        profileRole.textContent = "";
      }
    }

    function toggleUserMenu() {
      const isOpen = userDropdownMenu.classList.contains("show");
      userDropdownMenu.classList.toggle("show", !isOpen);
      userDropdownToggle.setAttribute("aria-expanded", String(!isOpen));
    }

    userDropdownToggle.onclick = (e) => {
      e.preventDefault();
      toggleUserMenu();
    };

    document.addEventListener("click", (e) => {
      if (!userDropdown.contains(e.target)) {
        userDropdownMenu.classList.remove("show");
        userDropdownToggle.setAttribute("aria-expanded", "false");
      }
    });

    ddProfile.onclick = async (e) => {
      e.preventDefault();
      if (!loggedInUser) return;
      showSection(profileSection);
      await loadProfile();
    };

    const comingSoon = (e) => {
      e.preventDefault();
      alert("Feature coming soon!");
    };

    ddEmployees.onclick = async (e) => {
      e.preventDefault();
      showSection(employeesSection);
      resetEmployeeForm();
      await Promise.all([loadEmployees(), populateDeptDropdown()]);
    };

    btnAddEmployee.onclick = () => {
      resetEmployeeForm();
    };

    empSaveBtn.onclick = async (e) => {
      e.preventDefault();
      await saveEmployee();
    };

    empCancelBtn.onclick = (e) => {
      e.preventDefault();
      resetEmployeeForm();
    };

    ddAccounts.onclick = async (e) => {
      e.preventDefault();
      showSection(accountsSection);
      resetAccountForm();
      await loadAccounts();
    };

    btnAddAccount.onclick = () => {
      resetAccountForm();
    };

    accSaveBtn.onclick = async (e) => {
      e.preventDefault();
      await saveAccount();
    };

    accCancelBtn.onclick = (e) => {
      e.preventDefault();
      resetAccountForm();
    };

    ddDepartments.onclick = async (e) => {
      e.preventDefault();
      showSection(departmentsSection);
      resetDeptForm();
      await loadDepartments();
    };

    btnAddDepartment.onclick = () => {
      resetDeptForm();
    };

    deptSaveBtn.onclick = async (e) => {
      e.preventDefault();
      await saveDepartment();
    };

    deptCancelBtn.onclick = (e) => {
      e.preventDefault();
      resetDeptForm();
    };

    ddRequests.onclick = async (e) => {
      e.preventDefault();
      showSection(requestsSection);
      await loadRequests();
    };

    btnNewRequest.onclick = (e) => {
      e.preventDefault();
      resetRequestForm();
      newRequestCard.classList.remove("d-none");
    };

    btnCloseRequest.onclick = (e) => {
      e.preventDefault();
      newRequestCard.classList.add("d-none");
    };

    btnAddItem.onclick = (e) => {
      e.preventDefault();
      addRequestItem();
    };

    btnSubmitRequest.onclick = async (e) => {
      e.preventDefault();
      await submitRequest();
    };



    ddLogout.onclick = (e) => {
      e.preventDefault();
      sessionStorage.removeItem(AUTH_TOKEN_KEY);
      applyAuthState(null);
      showSection(homeSection);
    };

    editProfileBtn.onclick = () => {
      editProfileCard.classList.toggle("d-none");
      editProfileAlert.innerHTML = '';
    };

    saveProfileBtn.onclick = async (e) => {
      e.preventDefault();
      await saveProfile();
    };

    cancelEditProfileBtn.onclick = () => {
      editProfileCard.classList.add("d-none");
      editProfileAlert.innerHTML = '';
    };

    window.addEventListener("load", tryRestoreSession);
  </script>

</body>

</html>